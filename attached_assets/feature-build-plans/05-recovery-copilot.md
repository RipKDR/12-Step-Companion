# Recovery Copilot Feature - BMAD Build Plan

## B — Background (Context, Constraints, Guardrails)

### Context
Recovery Copilot is an AI companion grounded in user data (step work, journals, scenes, daily check-ins). Research shows AI conversational agents reduce substance use and distress when they feel supportive and human-ish. This feature transforms the app from tool to companion.

### Current State
- ✅ Basic AI Sponsor chat exists (`client/src/routes/AISponsor.tsx`)
- ✅ Gemini API integration exists
- ✅ `AISponsorChatState` type exists
- ❌ Not grounded in user data
- ❌ Not agentic (doesn't proactively help)
- ❌ Generic responses (not personalized)

### Hard Constraints
- **Privacy-First**: User data stays local, only summaries sent to AI (if using cloud AI)
- **On-Device Option**: Prefer on-device AI where possible (future)
- **Copyright**: Never quote copyrighted NA/AA text
- **Transparency**: Always show what data is used for context
- **Opt-In**: Users control what data is shared with AI

### Principles
- **BMAD**: Operate in Background → Mission → Actions → Deliverables cycles
- **Challenge Assumptions**: Why not just use ChatGPT? Answer: Grounded in recovery data, recovery-focused, integrated with app
- **Ship Small**: Start with basic chat, add agentic features later

### Risks & Mitigations
1. **Risk**: Feels like replacement for sponsor → **Mitigation**: Clear language "I'm a companion, not a sponsor", always encourage human connection
2. **Risk**: Privacy concerns → **Mitigation**: Local-first, opt-in sharing, clear what data is used
3. **Risk**: Generic responses → **Mitigation**: Ground in user data, personalize prompts
4. **Risk**: Cost (API calls) → **Mitigation**: Cache responses, batch requests, on-device option

---

## M — Mission (What to Build)

### Core Features

#### 1. Grounded Chat
- **Context Window**: Include recent step work, journals, scenes, daily check-ins
- **Personalized Prompts**: Tailor responses to user's recovery journey
- **Recovery-Focused**: Understand recovery context, not generic mental health
- **Transparent**: Show what data is used for context

#### 2. Agentic Features
- **Weekly Digest**: Generate weekly summary ("Here are 3 themes I've seen...")
- **Pattern Detection**: Notice recurring phrases/themes ("You often mention feeling like a burden")
- **Meeting Prep**: Help phrase shares for meetings
- **Sponsor Summaries**: Generate summaries to send to sponsor

#### 3. Proactive Help
- **Suggestions**: Proactively suggest actions based on patterns
- **Reminders**: Remind users of their own commitments ("You said you'd call your sponsor today")
- **Insights**: Share insights from their data ("Your mood tends to be lower on Fridays")

#### 4. Integration Points
- **Step Work**: Help with step questions, summarize progress
- **Journal**: Help process entries, identify themes
- **Scenes**: Help create/refine scenes
- **Daily Rhythm**: Reflect on daily check-ins

### Success Metrics
- **Engagement**: 50%+ of users chat weekly
- **Helpfulness**: 70%+ of users find responses helpful
- **Retention Impact**: 2x higher retention for users who chat regularly
- **Feature Usage**: 40%+ use agentic features (digest, summaries)

---

## A — Actions (Step-by-Step Implementation)

### A0. Sanity & Risk Pass
**Challenge Thinking:**
- Why not just use ChatGPT? → Answer: Grounded in recovery data, recovery-focused, integrated with app
- What about privacy? → Answer: Local-first, opt-in sharing, clear what data is used
- What if AI gives bad advice? → Answer: Clear disclaimers, encourage human connection, recovery-focused prompts

**Top Risks:**
1. Feels like replacement → Mitigation: Clear language, always encourage human connection
2. Privacy concerns → Mitigation: Local-first, opt-in, transparent
3. Generic responses → Mitigation: Ground in user data, personalize
4. Cost → Mitigation: Cache, batch, on-device option

### A1. Type System Updates

**File**: `client/src/types.ts`

```typescript
// Enhance existing AISponsorChatState
export interface AISponsorChatState {
  messages: AISponsorMessage[];
  isTyping: boolean;
  
  // NEW: Context window
  contextWindow: {
    recentStepWork?: string[]; // Last 5 step entries summaries
    recentJournals?: string[]; // Last 5 journal summaries
    activeScenes?: string[]; // Active Recovery Scenes
    currentStreaks?: Record<string, number>; // Streak data
    recentMoodTrend?: number[]; // Last 7 days mood
    recentCravingsTrend?: number[]; // Last 7 days cravings
  };
  
  // NEW: Agentic features
  weeklyDigest?: {
    generatedAtISO: string;
    themes: string[];
    summary: string;
    readyToShare: boolean;
  };
  
  // NEW: Settings
  settings: {
    includeStepWork: boolean;
    includeJournals: boolean;
    includeScenes: boolean;
    includeDailyCards: boolean;
    autoGenerateDigest: boolean; // Weekly digest
  };
}

export interface CopilotPrompt {
  id: string;
  type: "chat" | "digest" | "summary" | "meeting-prep" | "pattern-detection";
  userMessage: string;
  context: Record<string, any>; // What data is included
  response?: string;
  createdAtISO: string;
}
```

### A2. Context Gathering

**File**: `client/src/lib/copilot-context.ts` (NEW)

**Features:**
- Gather user data for context window
- Summarize step work entries
- Summarize journal entries
- Extract themes from data
- Build context prompt for AI

**Implementation:**
```typescript
export async function gatherContextForCopilot(
  includeStepWork: boolean,
  includeJournals: boolean,
  includeScenes: boolean,
  includeDailyCards: boolean
): Promise<CopilotContext> {
  // Gather data from Zustand store
  // Summarize entries
  // Extract themes
  // Return context object
}

export function buildContextPrompt(context: CopilotContext): string {
  // Build prompt with context
  // Include recovery-focused instructions
  // Return formatted prompt
}
```

### A3. Prompt Engineering

**File**: `client/src/lib/copilot-prompts.ts` (NEW)

**Features:**
- Recovery-focused system prompts
- Context-aware prompts
- Agentic feature prompts (digest, summaries)
- Meeting prep prompts
- Pattern detection prompts

**Implementation:**
```typescript
export const SYSTEM_PROMPT = `
You are a recovery companion helping someone in 12-step recovery.
- You are NOT a therapist or sponsor - you're a digital companion
- Always encourage human connection (sponsor, meetings, recovery friends)
- Never quote copyrighted NA/AA literature - paraphrase and summarize only
- Ground your responses in the user's own data (step work, journals, scenes)
- Be supportive, empathetic, and recovery-focused
- Help users process their own thoughts, not give medical advice
`;

export function buildChatPrompt(
  userMessage: string,
  context: CopilotContext
): string {
  // Include system prompt
  // Include context window
  // Include user message
  // Return formatted prompt
}
```

### A4. UI Components

#### A4.1 Enhanced Chat Component

**File**: `client/src/routes/AISponsor.tsx` (ENHANCE)

**Features:**
- Show context indicator (what data is included)
- Show transparency badge ("Using your step work, journals, scenes")
- Agentic action buttons (digest, summary, meeting prep)
- Pattern detection alerts ("I noticed you often mention...")

**UI Design:**
- Chat interface (existing)
- Context indicator at top (collapsible)
- Agentic action buttons (floating or sidebar)
- Pattern alerts (non-intrusive)

#### A4.2 Weekly Digest Component

**File**: `client/src/components/recovery-copilot/WeeklyDigest.tsx`

**Features:**
- Generate weekly summary
- Show themes detected
- Show insights
- Option to share with sponsor
- Option to save for later

**UI Design:**
- Card-based layout
- Themes section
- Summary section
- Action buttons (share, save, dismiss)
- Can regenerate if not satisfied

#### A4.3 Meeting Prep Component

**File**: `client/src/components/recovery-copilot/MeetingPrep.tsx`

**Features:**
- Help phrase share for meeting
- Suggest talking points
- Practice share (AI listens)
- Save share for later

**UI Design:**
- Text input (what do you want to share?)
- AI suggestions (phrased versions)
- Practice mode (voice or text)
- Save/share options

#### A4.4 Pattern Detection Component

**File**: `client/src/components/recovery-copilot/PatternDetection.tsx`

**Features:**
- Show detected patterns ("You often mention...")
- Suggest exploration ("Want to explore this?")
- Link to step work or journal
- Dismiss or save for later

**UI Design:**
- Card with pattern description
- "Explore" or "Save for step work" buttons
- Can dismiss
- Non-intrusive

### A5. Agentic Features Implementation

#### A5.1 Weekly Digest Generator

**File**: `client/src/lib/copilot-digest.ts` (NEW)

**Features:**
- Analyze week's data (step work, journals, daily cards)
- Extract themes
- Generate summary
- Suggest actions

**Implementation:**
```typescript
export async function generateWeeklyDigest(): Promise<WeeklyDigest> {
  // Gather week's data
  // Analyze for themes
  // Generate summary using AI
  // Return digest object
}
```

#### A5.2 Pattern Detection

**File**: `client/src/lib/copilot-patterns.ts` (NEW)

**Features:**
- Analyze journal entries for recurring phrases
- Analyze step work for themes
- Detect patterns (mood trends, trigger patterns)
- Suggest exploration

**Implementation:**
```typescript
export function detectPatterns(
  journals: JournalEntry[],
  stepWork: StepAnswer[]
): Pattern[] {
  // Analyze text for recurring phrases
  // Detect themes
  // Return patterns
}
```

#### A5.3 Sponsor Summary Generator

**File**: `client/src/lib/copilot-summary.ts` (NEW)

**Features:**
- Generate summary for sponsor
- Include key themes
- Include questions/concerns
- User can edit before sending

**Implementation:**
```typescript
export async function generateSponsorSummary(
  period: "week" | "month"
): Promise<SponsorSummary> {
  // Gather period's data
  // Generate summary
  // User can edit
  // Return summary
}
```

### A6. Integration Points

#### A6.1 Step Work Integration

**File**: `client/src/routes/Steps.tsx`

**Changes:**
- "Ask Copilot" button on step questions
- Help with phrasing answers
- Summarize step progress
- Suggest next steps

#### A6.2 Journal Integration

**File**: `client/src/routes/Journal.tsx`

**Changes:**
- "Process with Copilot" button on entries
- Help identify themes
- Suggest step work connections
- Generate insights

#### A6.3 Recovery Scenes Integration

**File**: `client/src/components/recovery-scenes/SceneEditor.tsx`

**Changes:**
- "Help me create this scene" button
- AI suggests triggers, actions, message
- Refine scene based on usage data

#### A6.4 Daily Rhythm Integration

**File**: `client/src/components/recovery-rhythm/EveningInventoryCard.tsx`

**Changes:**
- "Reflect on today" button
- AI reflects on daily check-ins
- Suggests insights or actions

### A7. Privacy & Security

**File**: `client/src/lib/copilot-privacy.ts` (NEW)

**Features:**
- Control what data is shared
- Local processing where possible
- Encrypted API calls (if using cloud AI)
- Clear privacy settings

**Implementation:**
- Settings UI for data sharing
- Local summarization (reduce data sent)
- Encryption for API calls
- Clear privacy policy

### A8. Testing

**Unit Tests:**
- `client/src/lib/__tests__/copilot-context.test.ts`
  - Test context gathering
  - Test prompt building
  - Test summarization

**Integration Tests:**
- `client/src/components/__tests__/WeeklyDigest.test.tsx`
  - Test digest generation
  - Test sharing
  - Test saving

**E2E Tests:**
- Chat with copilot → Get response → Check context used
- Generate weekly digest → Review → Share with sponsor

---

## D — Deliverables (What Must Exist)

### Code Deliverables
1. ✅ Enhanced `AISponsorChatState` with context window
2. ✅ Context gathering utilities (`copilot-context.ts`)
3. ✅ Prompt engineering (`copilot-prompts.ts`)
4. ✅ Enhanced chat component
5. ✅ Weekly digest component
6. ✅ Meeting prep component
6. ✅ Pattern detection component
7. ✅ Agentic features (digest, summaries, patterns)
8. ✅ Privacy controls
9. ✅ Integration with Step Work, Journal, Scenes, Daily Rhythm

### UX Deliverables
1. ✅ Chat feels personalized (grounded in user data)
2. ✅ Context is transparent (show what data is used)
3. ✅ Agentic features are discoverable
4. ✅ All components accessible (keyboard, screen reader)
5. ✅ Mobile-responsive

### Data Deliverables
1. ✅ Context gathered correctly
2. ✅ Prompts include recovery focus
3. ✅ Responses are helpful
4. ✅ Privacy settings respected

### Documentation Deliverables
1. ✅ README update: How Recovery Copilot works
2. ✅ User guide: How to use copilot features
3. ✅ Developer notes: Prompt engineering, privacy

---

## Success Criteria

### Must Have (MVP)
- [ ] Chat grounded in user data (step work, journals, scenes)
- [ ] Context window works (includes recent data)
- [ ] Responses are recovery-focused
- [ ] Privacy controls work (opt-in sharing)
- [ ] Basic chat functionality works

### Should Have (Enhanced)
- [ ] Weekly digest generation
- [ ] Pattern detection
- [ ] Meeting prep help
- [ ] Sponsor summary generation

### Nice to Have (Future)
- [ ] On-device AI (no API calls)
- [ ] Voice input/output
- [ ] Multi-language support
- [ ] Integration with wearables

---

## Implementation Timeline

### Week 1: Foundation
- Day 1-2: Context gathering system
- Day 3-4: Prompt engineering
- Day 5: Enhanced chat component

### Week 2: Agentic Features
- Day 1-2: Weekly digest generator
- Day 3: Pattern detection
- Day 4: Meeting prep
- Day 5: Sponsor summary

### Week 3: Integration
- Day 1-2: Integration with Step Work, Journal
- Day 3: Integration with Scenes, Daily Rhythm
- Day 4: Privacy controls
- Day 5: Testing + polish

### Week 4: Enhancement (Optional)
- Day 1-3: Advanced features
- Day 4-5: Optimization

---

## Notes & Considerations

### Privacy
- Local-first (summarize locally, send summaries only)
- Opt-in sharing (users control what data is shared)
- Clear privacy settings
- Encrypted API calls (if using cloud AI)

### Accessibility
- All components WCAG 2.2 AA compliant
- Keyboard navigation required
- Screen reader support required
- Clear language (not technical jargon)

### Performance
- Context gathering should be <500ms
- API calls should be cached
- Responses should be <3 seconds

### Edge Cases
- What if no data to include? → Use generic recovery prompts
- What if API fails? → Show error, suggest retry
- What if user disables all data sharing? → Use generic mode
- What if response is unhelpful? → Feedback loop, improve prompts

---

**Status**: Ready for Implementation
**Priority**: P1 (High Impact, Builds on Existing AI)
**Estimated Effort**: 3-4 weeks (MVP: 2 weeks)
**Dependencies**: Existing AI Sponsor chat, Gemini API

